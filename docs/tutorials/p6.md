# Tutorial B√°sico: Dexie.js - Base de Datos IndexedDB

## ¬øQu√© es Dexie.js?

Dexie.js es una librer√≠a JavaScript que simplifica el trabajo con IndexedDB (la base de datos del navegador). Te permite almacenar datos localmente en el navegador de forma f√°cil y r√°pida.

## ¬øPor qu√© usar Dexie.js?

- ‚úÖ **F√°cil de usar** - Sintaxis simple y clara
- ‚úÖ **Almacenamiento local** - Los datos se guardan en el navegador
- ‚úÖ **Sin servidor** - No necesitas backend
- ‚úÖ **R√°pido** - Acceso instant√°neo a los datos
- ‚úÖ **Offline** - Funciona sin conexi√≥n a internet

## Instalaci√≥n

### Opci√≥n 1: CDN (Recomendado para principiantes)
```html
<script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
```

### Opci√≥n 2: NPM
```bash
npm install dexie
```

## Conceptos B√°sicos

### Base de Datos
Un contenedor que guarda todas tus tablas.

### Tabla (Store)
Un conjunto de datos similares (como usuarios, productos, etc.).

### Registro
Un elemento individual en una tabla.

## Ejemplo Completo: Lista de Tareas

Vamos a crear una aplicaci√≥n simple de lista de tareas que guarda datos localmente.

### Archivo: `index.html`

```html
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Tareas con Dexie.js</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        button {
            padding: 12px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background: #0056b3;
        }

        .delete-btn {
            background: #dc3545;
            padding: 5px 10px;
            font-size: 12px;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .task-list {
            list-style: none;
        }

        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }

        .task-item.completed {
            opacity: 0.6;
            text-decoration: line-through;
            border-left-color: #28a745;
        }

        .task-text {
            flex: 1;
            margin-right: 10px;
        }

        .task-actions {
            display: flex;
            gap: 5px;
        }

        .complete-btn {
            background: #28a745;
            padding: 5px 10px;
            font-size: 12px;
        }

        .complete-btn:hover {
            background: #218838;
        }

        .stats {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìù Mi Lista de Tareas</h1>
        
        <div class="form-group">
            <input type="text" id="taskInput" placeholder="Escribe una nueva tarea...">
            <button onclick="addTask()">Agregar</button>
        </div>
        
        <ul id="taskList" class="task-list"></ul>
        
        <div class="stats">
            <p>Total de tareas: <span id="totalTasks">0</span></p>
            <p>Completadas: <span id="completedTasks">0</span></p>
        </div>
    </div>

    <!-- Dexie.js desde CDN -->
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
    
    <script>
        // 1. Crear la base de datos
        const db = new Dexie('TaskDatabase');
        
        // 2. Definir el esquema (estructura de la base de datos)
        db.version(1).stores({
            tasks: '++id, text, completed, createdAt'
        });
        
        // 3. Funciones para manejar tareas
        
        // Agregar nueva tarea
        async function addTask() {
            const input = document.getElementById('taskInput');
            const text = input.value.trim();
            
            if (text === '') {
                alert('Por favor escribe una tarea');
                return;
            }
            
            try {
                // Guardar en la base de datos
                await db.tasks.add({
                    text: text,
                    completed: false,
                    createdAt: new Date()
                });
                
                input.value = ''; // Limpiar el input
                loadTasks(); // Recargar la lista
                
            } catch (error) {
                console.error('Error al agregar tarea:', error);
                alert('Error al agregar la tarea');
            }
        }
        
        // Cargar todas las tareas
        async function loadTasks() {
            try {
                const tasks = await db.tasks.orderBy('createdAt').reverse().toArray();
                displayTasks(tasks);
                updateStats(tasks);
                
            } catch (error) {
                console.error('Error al cargar tareas:', error);
            }
        }
        
        // Mostrar tareas en la p√°gina
        function displayTasks(tasks) {
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';
            
            tasks.forEach(task => {
                const li = document.createElement('li');
                li.className = `task-item ${task.completed ? 'completed' : ''}`;
                
                li.innerHTML = `
                    <span class="task-text">${task.text}</span>
                    <div class="task-actions">
                        <button class="complete-btn" onclick="toggleTask(${task.id})">
                            ${task.completed ? 'Desmarcar' : 'Completar'}
                        </button>
                        <button class="delete-btn" onclick="deleteTask(${task.id})">
                            Eliminar
                        </button>
                    </div>
                `;
                
                taskList.appendChild(li);
            });
        }
        
        // Marcar/desmarcar tarea como completada
        async function toggleTask(id) {
            try {
                const task = await db.tasks.get(id);
                await db.tasks.update(id, { completed: !task.completed });
                loadTasks();
                
            } catch (error) {
                console.error('Error al actualizar tarea:', error);
            }
        }
        
        // Eliminar tarea
        async function deleteTask(id) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta tarea?')) {
                try {
                    await db.tasks.delete(id);
                    loadTasks();
                    
                } catch (error) {
                    console.error('Error al eliminar tarea:', error);
                }
            }
        }
        
        // Actualizar estad√≠sticas
        function updateStats(tasks) {
            const total = tasks.length;
            const completed = tasks.filter(task => task.completed).length;
            
            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completedTasks').textContent = completed;
        }
        
        // Permitir agregar tarea con Enter
        document.getElementById('taskInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addTask();
            }
        });
        
        // Cargar tareas al iniciar la p√°gina
        window.addEventListener('load', loadTasks);
    </script>
</body>
</html>
```

## Explicaci√≥n del C√≥digo

### 1. Crear la Base de Datos
```javascript
const db = new Dexie('TaskDatabase');
```
Crea una nueva base de datos llamada "TaskDatabase".

### 2. Definir el Esquema
```javascript
db.version(1).stores({
    tasks: '++id, text, completed, createdAt'
});
```

- `++id`: ID auto-incremental (clave primaria)
- `text`: Texto de la tarea
- `completed`: Si est√° completada (true/false)
- `createdAt`: Fecha de creaci√≥n

### 3. Operaciones CRUD

#### Crear (CREATE)
```javascript
await db.tasks.add({
    text: text,
    completed: false,
    createdAt: new Date()
});
```

#### Leer (READ)
```javascript
const tasks = await db.tasks.orderBy('createdAt').reverse().toArray();
```

#### Actualizar (UPDATE)
```javascript
await db.tasks.update(id, { completed: !task.completed });
```

#### Eliminar (DELETE)
```javascript
await db.tasks.delete(id);
```

## Pasos para Probar

1. **Crea el archivo** - Guarda el c√≥digo como `index.html`
2. **Abre en el navegador** - Haz doble clic en el archivo
3. **Prueba la aplicaci√≥n**:
   - Escribe una tarea y presiona "Agregar"
   - Marca tareas como completadas
   - Elimina tareas
   - Recarga la p√°gina (los datos se mantienen)

## Caracter√≠sticas de la Aplicaci√≥n

- ‚úÖ **Agregar tareas** nuevas
- ‚úÖ **Marcar como completadas**
- ‚úÖ **Eliminar tareas**
- ‚úÖ **Persistencia** - Los datos se guardan localmente
- ‚úÖ **Estad√≠sticas** - Contador de tareas totales y completadas
- ‚úÖ **Interfaz responsive** - Se adapta a diferentes pantallas

## Conceptos Clave de Dexie.js

### Async/Await
Todas las operaciones de base de datos son as√≠ncronas:
```javascript
// ‚úÖ Correcto
async function getData() {
    const data = await db.table.toArray();
}

// ‚ùå Incorrecto
function getData() {
    const data = db.table.toArray(); // Esto devuelve una Promise
}
```

### M√©todos Principales

| M√©todo | Descripci√≥n | Ejemplo |
|--------|-------------|----------|
| `add()` | Agregar nuevo registro | `db.tasks.add({text: 'Tarea'})` |
| `get()` | Obtener por ID | `db.tasks.get(1)` |
| `toArray()` | Obtener todos | `db.tasks.toArray()` |
| `update()` | Actualizar registro | `db.tasks.update(1, {completed: true})` |
| `delete()` | Eliminar registro | `db.tasks.delete(1)` |
| `where()` | Filtrar datos | `db.tasks.where('completed').equals(true)` |

## Temas Clave Avanzados de Dexie.js

### 1. Transacciones

Las transacciones garantizan que m√∫ltiples operaciones se ejecuten como una unidad:

```javascript
// Transacci√≥n simple
db.transaction('rw', db.tasks, async () => {
    await db.tasks.add({text: 'Tarea 1', completed: false});
    await db.tasks.add({text: 'Tarea 2', completed: false});
    // Si una falla, ambas se revierten
});

// Transacci√≥n con manejo de errores
try {
    await db.transaction('rw', db.tasks, async () => {
        const task = await db.tasks.get(1);
        await db.tasks.update(1, {completed: !task.completed});
        await db.tasks.add({text: 'Nueva tarea', completed: false});
    });
    console.log('Transacci√≥n exitosa');
} catch (error) {
    console.error('Error en transacci√≥n:', error);
}
```

### 2. √çndices y Consultas Avanzadas

#### Definir √çndices
```javascript
db.version(1).stores({
    tasks: '++id, text, completed, createdAt, *tags' // *tags = √≠ndice multi-valor
});
```

#### Consultas con Filtros
```javascript
// Buscar tareas completadas
const completedTasks = await db.tasks
    .where('completed')
    .equals(true)
    .toArray();

// Buscar por rango de fechas
const recentTasks = await db.tasks
    .where('createdAt')
    .above(new Date('2024-01-01'))
    .toArray();

// Buscar con m√∫ltiples condiciones
const filteredTasks = await db.tasks
    .where('completed')
    .equals(false)
    .and(task => task.text.includes('importante'))
    .toArray();

// Ordenar resultados
const sortedTasks = await db.tasks
    .orderBy('createdAt')
    .reverse()
    .limit(10)
    .toArray();
```

### 3. Manejo de Errores

#### Tipos de Errores Comunes
```javascript
try {
    await db.tasks.add({text: 'Nueva tarea'});
} catch (error) {
    if (error.name === 'ConstraintError') {
        console.error('Violaci√≥n de restricci√≥n:', error.message);
    } else if (error.name === 'DataError') {
        console.error('Error de datos:', error.message);
    } else if (error.name === 'QuotaExceededError') {
        console.error('Espacio de almacenamiento agotado');
    } else {
        console.error('Error desconocido:', error);
    }
}
```

#### Validaci√≥n de Datos
```javascript
// Hook para validar antes de insertar
db.tasks.hook('creating', function (primKey, obj, trans) {
    if (!obj.text || obj.text.trim() === '') {
        throw new Error('El texto de la tarea no puede estar vac√≠o');
    }
    if (obj.text.length > 200) {
        throw new Error('El texto no puede exceder 200 caracteres');
    }
});
```

### 4. Versionado de Base de Datos

```javascript
// Versi√≥n 1 - Esquema inicial
db.version(1).stores({
    tasks: '++id, text, completed, createdAt'
});

// Versi√≥n 2 - Agregar campo priority
db.version(2).stores({
    tasks: '++id, text, completed, createdAt, priority'
}).upgrade(trans => {
    // Migrar datos existentes
    return trans.tasks.toCollection().modify(task => {
        task.priority = 'medium'; // Valor por defecto
    });
});

// Versi√≥n 3 - Agregar nueva tabla
db.version(3).stores({
    tasks: '++id, text, completed, createdAt, priority',
    categories: '++id, name, color'
});
```

### 5. Optimizaci√≥n de Rendimiento

#### Usar Bulk Operations
```javascript
// ‚ùå Lento - m√∫ltiples operaciones
for (let i = 0; i < 1000; i++) {
    await db.tasks.add({text: `Tarea ${i}`, completed: false});
}

// ‚úÖ R√°pido - operaci√≥n en lote
const tasks = [];
for (let i = 0; i < 1000; i++) {
    tasks.push({text: `Tarea ${i}`, completed: false});
}
await db.tasks.bulkAdd(tasks);
```

#### Paginaci√≥n Eficiente
```javascript
// Paginaci√≥n con offset/limit
async function getTasks(page = 1, pageSize = 20) {
    const offset = (page - 1) * pageSize;
    
    const tasks = await db.tasks
        .orderBy('createdAt')
        .reverse()
        .offset(offset)
        .limit(pageSize)
        .toArray();
    
    const total = await db.tasks.count();
    
    return {
        tasks,
        total,
        page,
        totalPages: Math.ceil(total / pageSize)
    };
}
```

### 6. Hooks y Eventos

```javascript
// Hook antes de crear
db.tasks.hook('creating', function (primKey, obj, trans) {
    obj.createdAt = new Date();
    obj.id = undefined; // Dejar que se auto-genere
});

// Hook antes de actualizar
db.tasks.hook('updating', function (modifications, primKey, obj, trans) {
    modifications.updatedAt = new Date();
});

// Hook antes de eliminar
db.tasks.hook('deleting', function (primKey, obj, trans) {
    console.log(`Eliminando tarea: ${obj.text}`);
});
```

### 7. Trabajo con M√∫ltiples Tablas

```javascript
// Definir esquema con relaciones
db.version(1).stores({
    categories: '++id, name, color',
    tasks: '++id, text, completed, categoryId, createdAt'
});

// Consulta con JOIN manual
async function getTasksWithCategories() {
    const tasks = await db.tasks.toArray();
    const categories = await db.categories.toArray();
    
    return tasks.map(task => ({
        ...task,
        category: categories.find(cat => cat.id === task.categoryId)
    }));
}

// Operaci√≥n en m√∫ltiples tablas
await db.transaction('rw', [db.categories, db.tasks], async () => {
    const categoryId = await db.categories.add({
        name: 'Trabajo',
        color: '#ff6b6b'
    });
    
    await db.tasks.add({
        text: 'Revisar emails',
        completed: false,
        categoryId: categoryId
    });
});
```

### 8. Mejores Pr√°cticas

#### ‚úÖ Buenas Pr√°cticas
```javascript
// 1. Siempre usar async/await
async function addTask(text) {
    try {
        const id = await db.tasks.add({text, completed: false});
        return id;
    } catch (error) {
        console.error('Error:', error);
        throw error;
    }
}

// 2. Validar datos antes de guardar
function validateTask(task) {
    if (!task.text || task.text.trim() === '') {
        throw new Error('Texto requerido');
    }
    return true;
}

// 3. Usar transacciones para operaciones relacionadas
async function moveTaskToCategory(taskId, categoryId) {
    await db.transaction('rw', db.tasks, async () => {
        const task = await db.tasks.get(taskId);
        if (!task) throw new Error('Tarea no encontrada');
        
        await db.tasks.update(taskId, {
            categoryId: categoryId,
            updatedAt: new Date()
        });
    });
}
```

#### ‚ùå Evitar
```javascript
// No usar callbacks anidados
db.tasks.toArray().then(tasks => {
    db.categories.toArray().then(categories => {
        // Callback hell
    });
});

// No hacer m√∫ltiples consultas en bucles
for (const task of tasks) {
    const category = await db.categories.get(task.categoryId); // ‚ùå Lento
}
```

## Ventajas de IndexedDB con Dexie.js

- üì± **Funciona offline** - No necesita internet
- üíæ **Almacenamiento grande** - Hasta varios GB de datos
- ‚ö° **R√°pido** - Acceso instant√°neo
- üîí **Seguro** - Los datos solo est√°n en el navegador del usuario
- üåê **Compatible** - Funciona en todos los navegadores modernos
